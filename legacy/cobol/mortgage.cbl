       IDENTIFICATION DIVISION.
       PROGRAM-ID. MORTGAGE-CALCULATOR.
       AUTHOR. IBM-7090-MAINFRAME.
       DATE-WRITTEN. 1959-RESURRECTED-2024.
      *****************************************************************
      * ANCIENT COBOL MORTGAGE CALCULATION SUBROUTINE                *
      * COMPUTES MONTHLY PAYMENT USING AMORTIZATION FORMULA          *
      *****************************************************************
       
       ENVIRONMENT DIVISION.
       
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       
      * INPUT PARAMETERS FROM COMMAND LINE
       01 WS-INPUT-DATA.
          05 WS-PRINCIPAL-STR      PIC X(20).
          05 WS-RATE-STR           PIC X(20).
          05 WS-TERM-STR           PIC X(20).
       
      * NUMERIC WORKING VARIABLES
       01 WS-CALCULATED-DATA.
          05 WS-PRINCIPAL          PIC 9(8)V99.
          05 WS-ANNUAL-RATE        PIC 99V99.
          05 WS-MONTHLY-RATE       COMP-2.
          05 WS-NUM-PAYMENTS       PIC 999.
          05 WS-MONTHLY-PAYMENT    COMP-2.
          05 WS-POWER-TERM         COMP-2.
          05 WS-NUMERATOR          COMP-2.
          05 WS-DENOMINATOR        COMP-2.
          05 WS-TEMP-CALC          COMP-2.
       
      * OUTPUT FORMATTING
       01 WS-OUTPUT-DATA.
          05 WS-PAYMENT-FORMATTED  PIC ZZZZZZ9.99.
       
      * VALIDATION FLAGS
       01 WS-VALIDATION.
          05 WS-VALID-INPUT        PIC 9 VALUE 1.
             88 INPUT-VALID        VALUE 1.
             88 INPUT-INVALID      VALUE 0.
       
      * LOOP COUNTER FOR POWER CALCULATION
       01 WS-LOOP-COUNTER          PIC 999.
       
       PROCEDURE DIVISION.
       MAIN-PROCEDURE.
      *    ACCEPT COMMAND LINE ARGUMENTS
           ACCEPT WS-PRINCIPAL-STR FROM ARGUMENT-VALUE
           ACCEPT WS-RATE-STR FROM ARGUMENT-VALUE
           ACCEPT WS-TERM-STR FROM ARGUMENT-VALUE
           
      *    VALIDATE ARGUMENTS RECEIVED
           IF WS-PRINCIPAL-STR = SPACES OR
              WS-RATE-STR = SPACES OR
              WS-TERM-STR = SPACES
              DISPLAY "ERROR: INSUFFICIENT ARGUMENTS" UPON SYSERR
              STOP RUN RETURNING 1
           END-IF
           
      *    VALIDATE STRING INPUTS ARE NUMERIC
           IF FUNCTION TEST-NUMVAL(WS-PRINCIPAL-STR) NOT = 0 OR
              FUNCTION TEST-NUMVAL(WS-RATE-STR) NOT = 0 OR
              FUNCTION TEST-NUMVAL(WS-TERM-STR) NOT = 0
              DISPLAY "ERROR: NON-NUMERIC INPUT DETECTED" UPON SYSERR
              STOP RUN RETURNING 1
           END-IF
           
      *    CONVERT STRING INPUTS TO NUMERIC
           MOVE FUNCTION NUMVAL(WS-PRINCIPAL-STR) TO WS-PRINCIPAL
           MOVE FUNCTION NUMVAL(WS-RATE-STR) TO WS-ANNUAL-RATE
           MOVE FUNCTION NUMVAL(WS-TERM-STR) TO WS-NUM-PAYMENTS
           
      *    VALIDATE NUMERIC RANGES
           PERFORM VALIDATE-INPUTS
           
           IF INPUT-INVALID
              STOP RUN RETURNING 1
           END-IF
           
      *    PERFORM MORTGAGE CALCULATION
           PERFORM CALCULATE-MORTGAGE
           
      *    OUTPUT RESULT TO STDOUT
           MOVE WS-MONTHLY-PAYMENT TO WS-PAYMENT-FORMATTED
           DISPLAY "RESULT: " WS-PAYMENT-FORMATTED
           
           STOP RUN RETURNING 0.
       
       VALIDATE-INPUTS.
      *    CHECK PRINCIPAL IS POSITIVE (ALSO CATCHES NEGATIVE)
           IF WS-PRINCIPAL <= 0 OR WS-PRINCIPAL-STR(1:1) = "-"
              DISPLAY "ERROR: INVALID PRINCIPAL AMOUNT" UPON SYSERR
              SET INPUT-INVALID TO TRUE
              EXIT PARAGRAPH
           END-IF
           
      *    CHECK RATE IS POSITIVE (ALSO CATCHES NEGATIVE)
           IF WS-ANNUAL-RATE <= 0 OR WS-RATE-STR(1:1) = "-"
              DISPLAY "ERROR: INVALID INTEREST RATE" UPON SYSERR
              SET INPUT-INVALID TO TRUE
              EXIT PARAGRAPH
           END-IF
           
      *    CHECK TERM IS POSITIVE (ALSO CATCHES NEGATIVE)
           IF WS-NUM-PAYMENTS <= 0 OR WS-TERM-STR(1:1) = "-"
              DISPLAY "ERROR: INVALID LOAN TERM" UPON SYSERR
              SET INPUT-INVALID TO TRUE
              EXIT PARAGRAPH
           END-IF.
       
       CALCULATE-MORTGAGE.
      *    CONVERT ANNUAL RATE TO MONTHLY DECIMAL RATE
      *    DIVIDE BY 1200 TO COMBINE OPERATIONS (REDUCES ROUNDING)
           COMPUTE WS-MONTHLY-RATE = WS-ANNUAL-RATE / 1200
           
      *    CONVERT YEARS TO MONTHS
           COMPUTE WS-NUM-PAYMENTS = WS-NUM-PAYMENTS * 12
           
      *    CALCULATE (1 + i)^n USING POWER FUNCTION
           COMPUTE WS-POWER-TERM = (1 + WS-MONTHLY-RATE) 
                                   ** WS-NUM-PAYMENTS
           
      *    CALCULATE NUMERATOR: P * i * (1 + i)^n
           COMPUTE WS-NUMERATOR = WS-PRINCIPAL * WS-MONTHLY-RATE 
                                  * WS-POWER-TERM
           
      *    CALCULATE DENOMINATOR: (1 + i)^n - 1
           COMPUTE WS-DENOMINATOR = WS-POWER-TERM - 1
           
      *    CALCULATE MONTHLY PAYMENT: M = NUMERATOR / DENOMINATOR
           COMPUTE WS-MONTHLY-PAYMENT = WS-NUMERATOR / WS-DENOMINATOR.
       
       END PROGRAM MORTGAGE-CALCULATOR.
